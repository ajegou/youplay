#!/bin/bash

youplay_folder=$(readlink -f "${BASH_SOURCE[0]}" | xargs dirname)
[[ ! -f $youplay_folder/youplay_args ]] && { echo "Could not find args parser!"; exit 1; } 
source $youplay_folder/youplay_args

[[ "$audio_only" == "true" ]] && format="bestaudio" || format=$video_format

src="$*"
while read id; do # Loop in case we are reading a playlist
  url="https://www.youtube.com/watch?v=$id"
  info=$(youtube-dl --get-title --get-url --format $format "$url")
  title=$(echo -e "$info" | head -1)
  stream=$(echo -e "$info" | tail -1)


  # Record history
  ts=$(date '+%s')
  date=$(date '+%Y-%m-%d %H:%M:%S')
  [[ "$record_history" == "true" ]] && echo -e "$ts\t$date\t$url\t$title" >> "$history_file"

  # Play
  echo -e "Playing: $title ($url)"
  ${player} "$stream" > /dev/null 2>&1 </dev/tty
  exit_code=$?
  # For playlists: break the loop if the video is stopped with a ctrl-c or error
  [[ $exit_code != 0 && $exit_code != 3 ]] && break # omxplayer exits with 0 when stopped with 'q'
done < <(youtube-dl --get-id "$src")

$youplay_folder/yousearch "$src"
